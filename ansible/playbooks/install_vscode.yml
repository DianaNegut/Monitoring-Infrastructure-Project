---
- name: Install VS Code Server (Browser-based)
  hosts: employee_stations
  become: yes
  vars:
    code_server_version: "4.20.0"
  tasks:
    - name: Install dependencies
      apt:
        name:
          - curl
          - wget
        state: present
      when: ansible_os_family == "Debian"

    - name: Download code-server
      get_url:
        url: "https://github.com/coder/code-server/releases/download/v{{ code_server_version }}/code-server_{{ code_server_version }}_amd64.deb"
        dest: "/tmp/code-server.deb"

    - name: Install code-server
      apt:
        deb: "/tmp/code-server.deb"
      when: ansible_os_family == "Debian"

    - name: Create code-server config directory
      file:
        path: /home/admin/.config/code-server
        state: directory
        owner: admin
        group: admin
        mode: '0755'

    - name: Configure code-server
      copy:
        dest: /home/admin/.config/code-server/config.yaml
        content: |
          bind-addr: 0.0.0.0:8080
          auth: password
          password: admin123
          cert: false
        owner: admin
        group: admin
        mode: '0644'

    - name: Start code-server as background process
      shell: nohup code-server --bind-addr 0.0.0.0:8080 > /var/log/code-server.log 2>&1 &
      become_user: admin
      async: 10
      poll: 0

    - name: Display access information
      debug:
        msg: "VS Code Server accessible at http://{{ ansible_hostname }}:8080 with password 'admin123'"
