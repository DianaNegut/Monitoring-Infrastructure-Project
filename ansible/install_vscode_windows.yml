---
# =============================================================================
# Playbook: Install Visual Studio Code on Windows Workstations via SSH
# =============================================================================
# Purpose: Install VS Code on Windows workstations using SSH
# Method: Download on manager, SCP to workstation, install via PowerShell
#
# Run: ansible-playbook -i inventory.yml install_vscode_windows.yml
# =============================================================================

# =============================================================================
# Play 1: Download VS Code installer on Manager (localhost - you're already here)
# =============================================================================
- name: Download VS Code Installer on Manager
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    packages_dir: /home/ubuntu/packages
    vscode_installer: "VSCodeUserSetup-x64.exe"
    vscode_url: "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-user"

  tasks:
    - name: Create packages directory
      file:
        path: "{{ packages_dir }}"
        state: directory
        mode: '0755'

    - name: Check if VS Code installer exists
      stat:
        path: "{{ packages_dir }}/{{ vscode_installer }}"
      register: vscode_exists

    - name: Download VS Code installer
      get_url:
        url: "{{ vscode_url }}"
        dest: "{{ packages_dir }}/{{ vscode_installer }}"
        mode: '0644'
      when: not vscode_exists.stat.exists
      register: download_result
      retries: 3
      delay: 5
      until: download_result is success

    - name: Display download status
      debug:
        msg: "{{ '‚úÖ VS Code installer ready' if vscode_exists.stat.exists or download_result is success else '‚ùå Download failed' }}"


# =============================================================================
# Play 2: Install VS Code on Windows Workstations via SSH
# =============================================================================
- name: Install VS Code on Windows Workstations
  hosts: workstations
  gather_facts: no

  vars:
    packages_dir: /home/ubuntu/packages
    vscode_installer: "VSCodeUserSetup-x64.exe"
    local_installer_path: "C:\\Users\\Windows\\{{ vscode_installer }}"

  tasks:
    - name: Display host being processed
      debug:
        msg: "üíª Installing VS Code on {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Check if VS Code is already installed
      raw: 'powershell.exe -Command "if (Test-Path ''C:\Users\{{ ansible_user }}\AppData\Local\Programs\Microsoft VS Code\Code.exe'') { Write-Host ''exists'' } else { Write-Host ''not_found'' }"'
      register: vscode_check
      changed_when: false

    - name: Copy installer to Windows workstation via SCP
      local_action: >
        shell sshpass -p '{{ ansible_password }}' scp 
        -o ProxyCommand="sshpass -p vyos ssh -W %h:%p -o StrictHostKeyChecking=no vyos@10.102.11.252"
        -o StrictHostKeyChecking=no
        {{ packages_dir }}/{{ vscode_installer }}
        {{ ansible_user }}@{{ ansible_host }}:./{{ vscode_installer }}
      when: '"not_found" in vscode_check.stdout'

    - name: Install VS Code silently via PowerShell
      raw: 'powershell.exe -Command "Start-Process -FilePath ''{{ local_installer_path }}'' -ArgumentList ''/VERYSILENT'',''/NORESTART'',''/MERGETASKS=!runcode,addcontextmenufiles,addcontextmenufolders,associatewithfiles,addtopath'' -Wait"'
      when: '"not_found" in vscode_check.stdout'

    - name: Cleanup installer
      raw: 'powershell.exe -Command "Remove-Item -Path ''{{ local_installer_path }}'' -Force -ErrorAction SilentlyContinue"'

    - name: Verify installation
      raw: 'powershell.exe -Command "if (Test-Path ''C:\Users\{{ ansible_user }}\AppData\Local\Programs\Microsoft VS Code\Code.exe'') { Write-Host ''SUCCESS'' } else { Write-Host ''FAILED'' }"'
      register: vscode_verify
      changed_when: false

    - name: Display result
      debug:
        msg: "{{ '‚úÖ SUCCESS' if 'SUCCESS' in vscode_verify.stdout else '‚ùå FAILED' }}: {{ inventory_hostname }}"
